generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  company
  barber
}

enum CompanyAiType {
  nfe_import
  barber_booking
  billing
  restaurant_delivery
  clinic_booking
}

enum NfeStatus {
  detected
  imported
  failed
}

enum PromptScope {
  global
  company
}

enum MessageDirection {
  in
  out
}

enum MessageType {
  text
  media
  system
}

enum MessageProcessingStatus {
  received
  processed
  failed
  ignored
}

enum JobStatus {
  running
  success
  failed
}

enum MessageDispatchStatus {
  queued
  sending
  sent
  retry
  failed
  dead
}

enum AppointmentStatus {
  scheduled
  completed
  canceled
}

model User {
  id            String         @id @default(cuid())
  role          UserRole
  companyId     String?
  company       Company?       @relation(fields: [companyId], references: [id], onDelete: SetNull)
  barberProfile BarberProfile?
  email         String         @unique
  passwordHash  String
  active        Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  refreshTokens RefreshToken[]
}

model Company {
  id             String                  @id @default(cuid())
  cnpj           String                  @unique
  name           String
  email          String                  @unique
  evolutionInstanceName String?          @unique
  aiType         CompanyAiType           @default(nfe_import)
  bookingSector  String                  @default("barber")
  active         Boolean                 @default(true)
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt
  users          User[]
  certificates   CompanyCertificate[]
  whatsappNumbers CompanyWhatsappNumber[]
  prompts        AiPrompt[]
  nfeDocuments   NfeDocument[]
  barberProfiles BarberProfile[]
  barberServices BarberService[]
  appointments   BarberAppointment[]
  dfeSyncState   DfeSyncState?
  messageLogs    MessageLog[]
  conversationMemories ConversationMemory[]
  webhookEvents  WebhookEvent[]
  messageDispatches MessageDispatch[]
  rateLimitPolicies RateLimitPolicy[]
  operationalLimit CompanyOperationalLimit?
  jobRuns        JobRun[]
}

model BarberProfile {
  id             String             @id @default(cuid())
  companyId      String
  company        Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  userId         String?            @unique
  user           User?              @relation(fields: [userId], references: [id], onDelete: SetNull)
  name           String
  email          String?
  phoneE164      String?
  active         Boolean            @default(true)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  services       BarberService[]
  workingHours   BarberWorkingHour[]
  appointments   BarberAppointment[]

  @@index([companyId, active])
}

model BarberService {
  id              String              @id @default(cuid())
  companyId       String
  company         Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  barberId        String?
  barber          BarberProfile?      @relation(fields: [barberId], references: [id], onDelete: SetNull)
  name            String
  description     String?             @db.Text
  durationMinutes Int
  price           Decimal             @db.Decimal(10, 2)
  active          Boolean             @default(true)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  appointments    BarberAppointment[]

  @@index([companyId, active])
  @@index([barberId, active])
}

model BarberWorkingHour {
  id        String       @id @default(cuid())
  barberId  String
  barber    BarberProfile @relation(fields: [barberId], references: [id], onDelete: Cascade)
  weekday   Int
  startTime String
  endTime   String
  active    Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@index([barberId, weekday, active])
}

model BarberAppointment {
  id          String            @id @default(cuid())
  companyId   String
  company     Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  barberId    String
  barber      BarberProfile     @relation(fields: [barberId], references: [id], onDelete: Restrict)
  serviceId   String
  service     BarberService     @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  clientName  String
  clientPhone String
  startsAt    DateTime
  endsAt      DateTime
  status      AppointmentStatus @default(scheduled)
  source      String?
  notes       String?           @db.Text
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([companyId, startsAt])
  @@index([barberId, startsAt])
  @@index([status, startsAt])
}

model CompanyCertificate {
  id                   String    @id @default(cuid())
  companyId            String
  company              Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  pfxBlobEncrypted     Bytes     @db.LongBlob
  pfxPasswordEncrypted Bytes     @db.LongBlob
  validFrom            DateTime?
  validTo              DateTime?
  active               Boolean   @default(true)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@index([companyId, active])
}

model CompanyWhatsappNumber {
  id        String   @id @default(cuid())
  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  phoneE164 String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, phoneE164])
  @@index([phoneE164, active])
}

model AiPrompt {
  id         String         @id @default(cuid())
  scope      PromptScope
  companyId  String?
  company    Company?       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  category   CompanyAiType?
  promptText String         @db.Text
  version    Int
  active     Boolean        @default(true)
  createdAt  DateTime       @default(now())

  @@index([scope, companyId, active])
  @@index([scope, category, active])
}

model WhatsappSession {
  id          String   @id @default(cuid())
  sessionName String   @unique
  status      String
  qrLast      String?  @db.LongText
  connectedAt DateTime?
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())
}

model AppConfig {
  id                      String   @id @default("global")
  evolutionBaseUrl        String?
  evolutionApiKey         String?  @db.Text
  evolutionInstanceName   String?
  agentWhatsappNumber     String?
  groqApiKey              String?  @db.Text
  groqModel               String?
  sefazTpAmb              Int?
  sefazCUFAutor           Int?
  sefazNfeDistProdUrl     String?
  sefazNfeDistHomologUrl  String?
  sefazTimeoutMs          Int?
  sefazMaxBatchesPerSync  Int?
  syncMinIntervalSeconds  Int?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
}

model NfeDocument {
  id                  String     @id @default(cuid())
  companyId           String
  company             Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  chave               String
  nsu                 String?
  emitenteCnpj        String?
  emitenteNome        String?
  valorTotal          Decimal    @db.Decimal(15, 2)
  dataEmissao         DateTime?
  dataVencimento      DateTime?
  tipoOperacao        String?
  rawXmlBlobEncrypted Bytes      @db.LongBlob
  status              NfeStatus  @default(detected)
  importedAt          DateTime?
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt
  items               NfeItem[]

  @@unique([companyId, chave])
  @@index([companyId, status, dataEmissao])
}

model NfeItem {
  id         String      @id @default(cuid())
  nfeId      String
  nfe        NfeDocument @relation(fields: [nfeId], references: [id], onDelete: Cascade)
  codigo     String?
  descricao  String?
  ncm        String?
  cfop       String?
  qtd        Decimal     @db.Decimal(15, 4)
  vUnit      Decimal     @db.Decimal(15, 4)
  vTotal     Decimal     @db.Decimal(15, 2)
}

model DfeSyncState {
  id           String    @id @default(cuid())
  companyId    String    @unique
  company      Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  ultimoNsu    String?
  ultimoSyncAt DateTime?
  ultimoSucessoAt DateTime?
  ultimoStatus String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model MessageLog {
  id         String                  @id @default(cuid())
  companyId  String
  company    Company                 @relation(fields: [companyId], references: [id], onDelete: Cascade)
  phoneE164  String
  direction  MessageDirection
  messageType MessageType
  content    String                  @db.LongText
  intent     String?
  status     MessageProcessingStatus @default(received)
  createdAt  DateTime                @default(now())

  @@index([companyId, createdAt])
}

model ConversationMemory {
  id            String   @id @default(cuid())
  companyId     String
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  phoneE164     String
  userName      String?
  lastIntent    String?
  contextJson   Json?
  lastInboundAt DateTime?
  lastOutboundAt DateTime?
  lastActivityAt DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([companyId, phoneE164])
  @@index([companyId, lastActivityAt])
}

model WebhookEvent {
  id          String   @id @default(cuid())
  provider    String
  eventType   String
  eventId     String?
  instanceName String?
  companyId   String?
  company     Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)
  payloadHash String
  payloadJson Json
  status      String
  receivedAt  DateTime @default(now())
  processedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([provider, eventId])
  @@index([provider, eventType, receivedAt])
  @@index([payloadHash, receivedAt])
  @@index([companyId, receivedAt])
}

model MessageDispatch {
  id               String                @id @default(cuid())
  companyId        String
  company          Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  instanceName     String?
  toPhoneE164      String
  messageLogId     String?
  payloadJson      Json
  intent           String?
  status           MessageDispatchStatus @default(queued)
  attempts         Int                   @default(0)
  maxAttempts      Int                   @default(5)
  nextAttemptAt    DateTime?
  sentAt           DateTime?
  providerMessageId String?
  errorCode        String?
  errorMessage     String?               @db.Text
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt

  @@index([status, nextAttemptAt])
  @@index([companyId, createdAt])
  @@index([instanceName, createdAt])
  @@index([messageLogId])
}

model RateLimitPolicy {
  id           String   @id @default(cuid())
  scope        String
  instanceName String?
  companyId    String?
  company      Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)
  maxPerMinute Int
  minDelayMs   Int      @default(1500)
  maxDelayMs   Int      @default(4500)
  burst        Int      @default(3)
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([scope, active])
  @@index([companyId, active])
  @@index([instanceName, active])
}

model CompanyOperationalLimit {
  id                 String   @id @default(cuid())
  companyId          String   @unique
  company            Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  maxInboundPerMinute Int     @default(120)
  maxOutboundPerMinute Int    @default(12)
  dailyOutboundCap   Int      @default(500)
  priority           Int      @default(100)
  active             Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model JobRun {
  id        String    @id @default(cuid())
  jobName   String
  companyId String?
  company   Company?  @relation(fields: [companyId], references: [id], onDelete: SetNull)
  status    JobStatus
  startedAt DateTime  @default(now())
  endedAt   DateTime?
  error     String?   @db.LongText

  @@index([jobName, startedAt])
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String   @unique
  jti       String   @unique
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime @default(now())

  @@index([userId, expiresAt])
}
